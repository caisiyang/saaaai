<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #ffffff;
            --card-bg: #1c1c1e;
            --card-hover: #2c2c2e;
            --modal-bg: #1c1c1e;
            --input-bg: #2c2c2e;
            --accent-color: #0a84ff;
            --danger-color: #ff453a;
        }

        body.light-mode {
            --bg-color: #f2f2f7;
            --text-color: #000000;
            --card-bg: #ffffff;
            --card-hover: #e5e5ea;
            --modal-bg: #ffffff;
            --input-bg: #e5e5ea;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            width: 600px;
            max-width: 100%;
            padding: 40px 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Header / Profile */
        .header-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 40px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .header-area:hover {
            opacity: 0.8;
        }

        .profile-bar {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .avatar {
            width: 96px;
            height: 96px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background-color: var(--card-bg);
        }

        .name {
            font-size: 24px;
            font-weight: 600;
            margin: 0 0 8px 0;
            letter-spacing: -0.5px;
        }

        .bio {
            font-size: 15px;
            opacity: 0.6;
            margin: 0;
            max-width: 400px;
            line-height: 1.4;
        }

        /* Grid System */
        #gridSystem {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            width: 100%;
        }

        .grid-slot {
            aspect-ratio: 1;
            position: relative;
            border-radius: 22px;
        }

        .grid-slot.wide {
            grid-column: span 2;
            aspect-ratio: auto;
            height: 100%;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 22px;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .card:hover {
            background-color: var(--card-hover);
            transform: scale(1.03);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .card:active {
            transform: scale(0.96);
        }

        .card-icon {
            font-size: 32px;
            margin-bottom: 12px;
            color: var(--text-color);
        }

        .card-text {
            font-size: 13px;
            font-weight: 500;
            text-align: center;
            padding: 0 12px;
            line-height: 1.3;
            color: var(--text-color);
        }

        .card-edit-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            backdrop-filter: blur(4px);
            transition: background 0.2s;
            z-index: 2;
        }

        .card-edit-btn:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        /* Empty slot styling for admin */
        .grid-slot.empty {
            border: 2px dashed rgba(128, 128, 128, 0.3);
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .grid-slot.empty:hover {
            border-color: var(--accent-color);
        }

        .grid-slot.empty::after {
            content: '+';
            font-size: 32px;
            color: rgba(128, 128, 128, 0.5);
            font-weight: 300;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal {
            background: var(--modal-bg);
            padding: 24px;
            border-radius: 24px;
            width: 85%;
            max-width: 360px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal h2 {
            margin: 0 0 20px 0;
            font-size: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 500;
            opacity: 0.6;
            margin-left: 4px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: none;
            background: var(--input-bg);
            color: var(--text-color);
            box-sizing: border-box;
            font-size: 16px;
            outline: none;
            transition: box-shadow 0.2s;
        }

        .form-control:focus {
            box-shadow: 0 0 0 2px var(--accent-color);
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: opacity 0.2s;
        }

        .btn:active {
            opacity: 0.7;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .theme-toggle:active {
            transform: scale(0.9);
        }

        /* Footer for secret door */
        .footer-area {
            height: 100px;
            width: 100%;
            margin-top: 40px;
        }
    </style>
</head>

<body>
    <div class="theme-toggle" onclick="toggleTheme()">
        <i id="themeIcon" class="fa-solid fa-sun"></i>
    </div>

    <div class="container">
        <div class="header-area">
            <div class="profile-bar">
                <img id="displayAvatar" class="avatar" src="" alt="Avatar">
                <div id="displayName" class="name"></div>
                <div id="displayBio" class="bio"></div>
            </div>
        </div>

        <div id="gridSystem">
            <!-- Grid items will be injected here -->
        </div>

        <div class="footer-area"></div>
    </div>

    <!-- Card Modal -->
    <div id="cardModal" class="modal-overlay">
        <div class="modal">
            <h2 id="cardModalTitle">编辑卡片</h2>
            <div class="form-group">
                <label>类型</label>
                <select id="cardType" class="form-control">
                    <option value="link">链接</option>
                    <option value="weixin">微信</option>
                    <option value="bilibili">B站</option>
                    <option value="github">GitHub</option>
                    <option value="mail">邮箱</option>
                    <option value="location">定位</option>
                    <option value="text">纯文本</option>
                </select>
            </div>
            <div class="form-group">
                <label>标题</label>
                <input type="text" id="cardTitle" class="form-control" placeholder="例如：我的博客">
            </div>
            <div class="form-group">
                <label>内容</label>
                <input type="text" id="cardContent" class="form-control" placeholder="URL 或 文本">
            </div>
            <div class="form-group">
                <label>宽度</label>
                <select id="cardWidth" class="form-control">
                    <option value="1">1x1 (正方形)</option>
                    <option value="2">2x1 (宽卡片)</option>
                </select>
            </div>
            <div class="btn-group">
                <button id="btnDelete" class="btn btn-danger" onclick="deleteCard()">删除</button>
                <button class="btn btn-primary btn-confirm" onclick="saveCard()">保存</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal-overlay">
        <div class="modal">
            <h2>编辑资料</h2>
            <div class="form-group">
                <label>昵称</label>
                <input type="text" id="editName" class="form-control">
            </div>
            <div class="form-group">
                <label>简介</label>
                <input type="text" id="editBio" class="form-control">
            </div>
            <div class="form-group">
                <label>头像链接</label>
                <input type="text" id="editAvatar" class="form-control">
            </div>
            <div class="btn-group">
                <button class="btn btn-primary btn-confirm" onclick="saveProfile()">保存</button>
            </div>
        </div>
    </div>

    <script>
        // ================= 配置区 =================
        // 1. 请在这里填入你的 Gist ID (就是 gist 网址最后那串数字字母)
        const GIST_ID = 'b9e8463f5dc1966839dc2f675bfabffe';

        // 2. Gist 里的文件名 (之前让你填的是 data.json)
        const GIST_FILENAME = 'data.json';

        // 3. 你的 GitHub Token (平时存在本地，只有编辑时才需要)
        // 手机上看不需要这个 Token，只有你要在手机上改数据时才需要输入
        let githubToken = localStorage.getItem('gh_token') || '';

        // 默认数据（万一云端被清空了用这个垫底）
        let appData = {
            profile: { name: "加载中...", bio: "正在从云端同步...", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Felix" },
            grid: Array(15).fill(null)
        };

        let isAdmin = false;
        let activeSlotIndex = -1;
        const iconMap = {
            link: "fa-solid fa-link", weixin: "fa-brands fa-weixin", location: "fa-solid fa-location-dot",
            bilibili: "fa-brands fa-bilibili", github: "fa-brands fa-github", mail: "fa-solid fa-envelope",
            text: "fa-solid fa-align-left"
        };

        // ================= 核心：真·云端同步逻辑 =================

        async function init() {
            applyTheme();

            // 页面一打开，立刻去 GitHub 拉取最新数据
            await loadFromCloud();

            // 绑定暗门 (底部连点5次)
            let clickCount = 0;
            let timer;
            // 绑定到 body 或者特定区域，防止有些布局挡住
            document.addEventListener('click', (e) => {
                // 只有点击页面底部 10% 的区域才算暗门，防止误触
                if (e.clientY > window.innerHeight * 0.9) {
                    clickCount++;
                    clearTimeout(timer);
                    timer = setTimeout(() => clickCount = 0, 1000);
                    if (clickCount === 5) {
                        enterAdminFlow();
                        clickCount = 0;
                    }
                }
            });
        }

        // 1. 从云端读取 (所有人都用这个)
        async function loadFromCloud() {
            if (!GIST_ID || GIST_ID === '你的_GIST_ID_填在这里') {
                alert("请在代码中填入正确的 GIST_ID！");
                renderAll(); // 渲染默认数据
                return;
            }

            try {
                // 发送请求给 GitHub
                const response = await fetch(`https://api.github.com/gists/${GIST_ID}`);
                if (!response.ok) throw new Error("网络请求失败");

                const data = await response.json();
                // 解析文件内容
                const content = data.files[GIST_FILENAME].content;

                // 更新 appData
                appData = JSON.parse(content);
                console.log("云端数据同步成功！");

            } catch (error) {
                console.error("同步失败，加载本地缓存或默认数据", error);
                // 如果断网了，尝试读取本地作为备份
                const localBackup = localStorage.getItem('myHomeBackup');
                if (localBackup) appData = JSON.parse(localBackup);
            }

            renderAll();
        }

        // 2. 保存到云端 (只有管理员用这个)
        async function saveToCloud() {
            if (!isAdmin || !githubToken) {
                alert("没有权限保存，请先进入管理员模式");
                return;
            }

            // 先保存一份到本地做备份，防止网不好丢数据
            localStorage.setItem('myHomeBackup', JSON.stringify(appData));

            const btnText = document.querySelector('.modal-overlay.active .btn-confirm');
            if (btnText) btnText.innerText = "正在上传...";

            try {
                const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: {
                            [GIST_FILENAME]: {
                                content: JSON.stringify(appData)
                            }
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error("保存失败，请检查 Token 或网络");
                }

                alert("保存成功！全网已同步。");

            } catch (error) {
                alert("保存出错: " + error.message);
            } finally {
                if (btnText) btnText.innerText = "保存";
            }
        }

        // ================= 渲染与逻辑 (保持不变) =================

        function renderAll() {
            renderProfile();
            renderGrid();
        }

        function renderProfile() {
            document.getElementById('displayName').textContent = appData.profile.name;
            document.getElementById('displayBio').textContent = appData.profile.bio;
            document.getElementById('displayAvatar').src = appData.profile.avatar;
        }

        function renderGrid() {
            const container = document.getElementById('gridSystem');
            container.innerHTML = '';

            appData.grid.forEach((item, index) => {
                const slot = document.createElement('div');
                slot.className = 'grid-slot';
                // 只有管理员能看到空格子
                if (!item) {
                    slot.className += ' empty';
                    if (isAdmin) {
                        slot.style.display = 'flex'; // 管理员显示空格
                        slot.onclick = () => openAddModal(index);
                    } else {
                        slot.style.display = 'none'; // 游客隐藏空格
                    }
                }

                // 允许拖拽 (仅管理员)
                if (isAdmin) {
                    slot.ondragover = (e) => e.preventDefault();
                    slot.ondrop = (e) => handleDrop(e, index);
                }

                if (item) {
                    if (item.width === "2") {
                        slot.classList.add('wide');
                        slot.style.gridColumn = "span 2";
                    }
                    const card = document.createElement('div');
                    card.className = `card ${item.width === "2" ? 'wide' : ''}`;
                    if (isAdmin) card.draggable = true;

                    card.innerHTML = `
                <i class="${iconMap[item.type]} card-icon"></i>
                <div class="card-text">${item.title}</div>
                ${isAdmin ? `<div class="card-edit-btn" onclick="openEditModal(${index}, event)"><i class="fa-solid fa-pen"></i></div>`
                            : ''}
            `;

                    // 点击事件：管理员没反应(靠编辑按钮)，游客跳转
                    card.onclick = () => {
                        if (!isAdmin) handleCardClick(item);
                    };

                    if (isAdmin) {
                        card.ondragstart = (e) => {
                            e.dataTransfer.setData('text/idx', index);
                            card.classList.add('dragging');
                        };
                        card.ondragend = () => card.classList.remove('dragging');
                    }

                    slot.appendChild(card);
                }
                container.appendChild(slot);
            });

            // 个人信息编辑
            document.querySelector('.header-area').onclick = (e) => {
                // 只有点到头像或文字区域才触发，且必须是管理员
                if (isAdmin && e.target.closest('.profile-bar')) {
                    openProfileModal();
                }
            };
        }

        // --- 业务操作 ---

        // 保存卡片 (统一入口)
        function saveCard() {
            const newItem = {
                type: document.getElementById('cardType').value,
                title: document.getElementById('cardTitle').value || "未命名",
                content: document.getElementById('cardContent').value,
                width: document.getElementById('cardWidth').value
            };
            appData.grid[activeSlotIndex] = newItem;
            closeModal('cardModal');
            renderAll(); // 先在本地渲染
            saveToCloud(); // 然后发给服务器
        }

        function deleteCard() {
            if (confirm("确定删除？")) {
                appData.grid[activeSlotIndex] = null;
                closeModal('cardModal');
                renderAll();
                saveToCloud();
            }
        }

        function saveProfile() {
            appData.profile.name = document.getElementById('editName').value;
            appData.profile.bio = document.getElementById('editBio').value;
            appData.profile.avatar = document.getElementById('editAvatar').value;
            closeModal('profileModal');
            renderAll();
            saveToCloud();
        }

        // 拖拽交换
        function handleDrop(e, targetIndex) {
            e.preventDefault();
            const sourceIndex = parseInt(e.dataTransfer.getData('text/idx'));
            if (sourceIndex === targetIndex) return;
            const sourceItem = appData.grid[sourceIndex];
            appData.grid[sourceIndex] = appData.grid[targetIndex];
            appData.grid[targetIndex] = sourceItem;
            renderAll();
            saveToCloud(); // 拖拽完自动保存
        }

        // --- 权限管理 ---
        function enterAdminFlow() {
            if (isAdmin) {
                // 如果已经是管理员，再次触发暗门则退出
                isAdmin = false;
                document.body.classList.remove('light-mode'); // 示意退出
                alert("已退出管理员模式");
                renderAll();
                return;
            }

            const token = prompt("请输入 GitHub Token 以编辑:", githubToken);
            if (token) {
                githubToken = token;
                localStorage.setItem('gh_token', token); // 记住密码
                isAdmin = true;
                renderAll();
                alert("管理员模式已开启！你可以编辑、拖拽了。");
            }
        }

        function handleCardClick(item) {
            if (item.type === 'weixin' || item.type === 'text') {
                navigator.clipboard.writeText(item.content);
                alert("已复制: " + item.content);
            } else if (item.content.startsWith('http')) {
                window.open(item.content, '_blank');
            } else {
                alert(item.content);
            }
        }

        // --- UI 工具 ---
        function openAddModal(index) {
            activeSlotIndex = index;
            document.getElementById('cardModalTitle').textContent = "添加";
            document.getElementById('cardTitle').value = "";
            document.getElementById('cardContent').value = "";
            document.getElementById('btnDelete').style.display = "none";
            openModal('cardModal');
        }
        function openEditModal(index, e) {
            e.stopPropagation();
            activeSlotIndex = index;
            const item = appData.grid[index];
            document.getElementById('cardModalTitle').textContent = "编辑";
            document.getElementById('cardTitle').value = item.title;
            document.getElementById('cardContent').value = item.content;
            document.getElementById('cardType').value = item.type;
            document.getElementById('cardWidth').value = item.width || "1";
            document.getElementById('btnDelete').style.display = "block";
            openModal('cardModal');
        }

        function openProfileModal() {
            document.getElementById('editName').value = appData.profile.name;
            document.getElementById('editBio').value = appData.profile.bio;
            document.getElementById('editAvatar').value = appData.profile.avatar;
            openModal('profileModal');
        }

        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('themeIcon');
            if (body.classList.contains('light-mode')) {
                body.classList.remove('light-mode');
                icon.className = 'fa-solid fa-sun';
                appData.theme = 'dark';
            } else {
                body.classList.add('light-mode');
                icon.className = 'fa-solid fa-moon';
                appData.theme = 'light';
            }
            // 主题偏好存本地即可，不必强行存云端，或者你也存云端：
            // saveToCloud();
        }
        function applyTheme() {
            // 简单处理：默认暗色，不做持久化读取了，让用户自己点
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        document.querySelectorAll('.modal-overlay').forEach(el => {
            el.addEventListener('click', (e) => {
                if (e.target === el) el.classList.remove('active');
            });
        });

        // 启动
        init();
    </script>
</body>

</html>