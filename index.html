<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的主页</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* ================= 基础变量 ================= */
        :root {
            --bg-color: #3a2e2e;
            --text-main: #fff;
            --text-sub: rgba(255, 255, 255, 0.7);
            
            /* 默认风格 */
            --card-bg: rgba(255, 255, 255, 0.1);
            --card-border: 1px solid rgba(255, 255, 255, 0.15);
            --card-blur: 25px;
            
            --slot-border: 2px dashed rgba(255, 255, 255, 0.15);
            --modal-bg: rgba(30, 30, 30, 0.9);
            --accent: #0a84ff;
            --radius-card: 20px;
            --gap-size: 12px; /* 稍微减小间距以适应手机 */
        }

        /* 样式变体 */
        body.style-dark { --card-bg: rgba(0, 0, 0, 0.5); --text-main: #fff; }
        body.style-white { --card-bg: rgba(255, 255, 255, 0.8); --text-main: #000; --text-sub: rgba(0,0,0,0.6); --card-border: 1px solid rgba(0,0,0,0.1); }
        body.no-border { --card-border: none; }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        /* 滚动条隐藏但保留功能 */
        ::-webkit-scrollbar { width: 0px; height: 0px; }

        body {
            background-color: var(--bg-color);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 30px;
            overflow-x: hidden;
            /* 允许页面滚动，但在管理模式下我们会禁止卡片区域的默认滚动 */
            overscroll-behavior-y: none; 
            transition: background-image 0.5s ease;
        }

        .app-container {
            width: 100%;
            max-width: 600px;
            padding: 10px; /* 手机端减小边距 */
            display: flex;
            flex-direction: column;
            position: relative;
            padding-bottom: 120px;
        }

        @media (min-width: 600px) {
            .app-container { padding: 20px; }
            :root { --gap-size: 15px; --radius-card: 24px; }
        }

        /* --- 管理员控制条 --- */
        .admin-controls {
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 2000; display: flex; gap: 10px; pointer-events: none;
        }
        .admin-btn {
            background: var(--accent); color: white; padding: 8px 20px;
            border-radius: 30px; font-size: 0.85rem; font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); pointer-events: auto; cursor: pointer;
            border: none; backdrop-filter: blur(10px);
        }
        .admin-btn.exit { background: rgba(0,0,0,0.6); }

        /* --- 头部 --- */
        .header-area {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding: 0 2px;
        }

        .profile-bar {
            flex: 1; height: 72px;
            background: var(--card-bg);
            backdrop-filter: blur(var(--card-blur)); -webkit-backdrop-filter: blur(var(--card-blur));
            border: var(--card-border); border-radius: 50px;
            display: flex; align-items: center; padding: 0 10px;
            margin-right: 10px; user-select: none;
            transition: transform 0.1s;
        }

        .avatar {
            width: 48px; height: 48px; border-radius: 50%;
            background: rgba(128,128,128,0.2); overflow: hidden;
            border: 1px solid rgba(255,255,255,0.2); flex-shrink: 0;
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        .info { margin-left: 12px; flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .name { font-size: 1.1rem; font-weight: 700; line-height: 1.2; }
        .bio { font-size: 0.8rem; color: var(--text-sub); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .settings-btn {
            width: 50px; height: 50px; border-radius: 50%;
            background: var(--card-bg); backdrop-filter: blur(var(--card-blur));
            border: var(--card-border); color: var(--text-main);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-size: 1.3rem; transition: transform 0.2s;
        }
        .settings-btn:active { transform: scale(0.9); }

        /* --- 网格系统 (核心修复) --- */
        .grid-system {
            display: grid;
            /* 这里的列数由 JS 动态写入内联样式 */
            /* 关键：行高自动，基于 aspect-ratio 撑开 */
            grid-auto-rows: auto; 
            gap: var(--gap-size);
            position: relative;
        }

        .grid-slot {
            position: relative;
            border-radius: var(--radius-card);
            /* 默认 1x1 的格子负责撑开行高 */
            aspect-ratio: 1/1; 
        }
        
        /* 跨格的 slot 不需要 aspect-ratio，它们跟随行高，只负责横向跨越 */
        .grid-slot.span-h2, .grid-slot.span-h3, .grid-slot.span-h4, .grid-slot.span-h5 {
            aspect-ratio: auto;
            height: 100%; /* 填满行高 */
        }
        
        .grid-slot.span-h2 { grid-column: span 2; }
        .grid-slot.span-h3 { grid-column: span 3; }
        .grid-slot.span-h4 { grid-column: span 4; }
        .grid-slot.span-h5 { grid-column: span 5; }
        
        /* 纵向跨格 (2x2) - 高度翻倍加间距 */
        .grid-slot.span-v2 { 
            grid-row: span 2; 
            aspect-ratio: auto; /* 高度由 grid track 决定 */
        }

        /* 空格子逻辑 */
        .grid-slot.empty {
            border: var(--slot-border);
            visibility: hidden; /* 默认不可见但占位 */
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; opacity: 0.4;
        }
        .grid-slot.empty::after { content: "+"; font-size: 2rem; color: var(--text-main); }
        
        /* 管理员模式下可见 */
        body.admin-mode .grid-slot.empty { visibility: visible; }

        /* --- 卡片核心 --- */
        .card {
            width: 100%; height: 100%;
            background: var(--card-bg);
            backdrop-filter: blur(var(--card-blur)); -webkit-backdrop-filter: blur(var(--card-blur));
            border: var(--card-border); border-radius: var(--radius-card);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; position: relative; z-index: 2; overflow: hidden;
            /* 默认允许滚动 */
            user-select: none; -webkit-user-select: none;
            transition: transform 0.15s ease;
        }
        
        /* 管理模式下的卡片：禁止默认触摸操作（如滚动），以便 JS 接管拖拽 */
        body.admin-mode .card {
            touch-action: none; 
            cursor: grab;
        }
        
        .card:active { transform: scale(0.96); }
        
        /* 拖拽状态 */
        .card.dragging-active {
            position: fixed; z-index: 9999; pointer-events: none;
            transform: scale(1.05) rotate(2deg); 
            box-shadow: 0 20px 40px rgba(0,0,0,0.5); 
            opacity: 0.95;
        }
        .card.dragging-placeholder { opacity: 0.2; background: rgba(0,0,0,0.1); border: 2px dashed rgba(255,255,255,0.2); }

        /* 跨格卡片内部布局调整 */
        .card.span-h { 
            flex-direction: row; gap: 15px; padding: 0 20px; justify-content: flex-start; 
        }
        
        /* 内容样式 - 响应式字体 */
        /* 使用 container query 思想，卡片越小字越小 */
        .card-icon { font-size: 1.8rem; margin-bottom: 8px; color: var(--text-main); pointer-events: none; }
        .card-title { font-size: 0.75rem; color: var(--text-sub); pointer-events: none; font-weight: 500; }
        .card-content { font-size: 0.9rem; color: var(--text-main); font-weight: 700; margin-top: 2px; display: none; pointer-events: none; word-break: break-all;}
        
        /* 横向卡片字体变大 */
        .card.span-h .card-icon { font-size: 2rem; margin: 0; }
        .card.span-h .card-text-box { text-align: left; overflow: hidden; }
        .card.span-h .card-title { font-size: 0.85rem; }
        .card.span-h .card-content { font-size: 1rem; }

        .card-bg-img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .card.type-image { padding: 0; border: none; }
        
        .card.type-weixin .card-content, .card.type-text .card-content { display: block; }
        .card.type-weixin .card-icon { font-size: 1.5rem; margin-bottom: 4px; }

        /* 二维码遮罩 */
        .qr-overlay {
            position: absolute; inset: 0; background: #fff;
            display: none; justify-content: center; align-items: center;
            z-index: 10; animation: fadeIn 0.2s;
        }
        .qr-overlay.show { display: flex; }
        .qr-img { width: 85%; height: 85%; object-fit: contain; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }

        /* 编辑按钮 */
        .card-edit-btn {
            position: absolute; top: 6px; right: 6px; width: 28px; height: 28px;
            background: rgba(0,0,0,0.6); border-radius: 50%; color: #fff;
            display: none; justify-content: center; align-items: center;
            font-size: 0.8rem; z-index: 20; cursor: pointer; backdrop-filter: blur(5px);
        }
        body.admin-mode .card .card-edit-btn { display: flex; }

        /* --- 弹窗美化 --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(12px);
            display: flex; justify-content: center; align-items: center; z-index: 3000;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .modal-box {
            background: var(--modal-bg); width: 90%; max-width: 380px;
            border-radius: 28px; padding: 25px; border: 1px solid rgba(255,255,255,0.15);
            max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;
            color: #fff; box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }
        
        .modal-section-title {
            font-size: 0.75rem; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 1px;
            margin-top: 10px; margin-bottom: 5px; font-weight: 700;
        }

        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-label { font-size: 0.85rem; color: rgba(255,255,255,0.7); }
        .form-input, .form-select {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: #fff;
            padding: 12px; border-radius: 12px; font-size: 1rem; width: 100%; outline: none;
            transition: background 0.2s;
        }
        .form-input:focus, .form-select:focus { background: rgba(255,255,255,0.15); border-color: var(--accent); }
        .form-select option { background-color: #222; color: #fff; padding: 10px; }
        
        .progress-bar { width: 100%; height: 4px; background: rgba(255,255,255,0.1); margin-top: 5px; border-radius: 2px; display: none; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; border-radius: 2px; transition: width 0.2s; }

        .btn { padding: 14px; border-radius: 14px; border: none; font-weight: 600; cursor: pointer; width: 100%; font-size: 1rem; }
        .btn-primary { background: var(--text-main); color: var(--bg-color); }
        .btn-danger { background: rgba(255, 69, 58, 0.2); color: #ff453a; border: 1px solid rgba(255, 69, 58, 0.3); }
        .btn-text { background: transparent; color: rgba(255,255,255,0.5); padding: 10px; font-size: 0.9rem; }
        
        input[type=range] { -webkit-appearance: none; background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; background: #fff; border-radius: 50%; cursor: pointer; margin-top: 0; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

    <div class="admin-controls" id="adminControls" style="display:none;">
        <button class="admin-btn">管理模式</button>
        <button class="admin-btn exit" onclick="exitAdminFlow()">退出并保存</button>
    </div>

    <div class="app-container">
        <!-- 头部 -->
        <div class="header-area">
            <div class="profile-bar">
                <div class="avatar"><img src="" id="displayAvatar"></div>
                <div class="info">
                    <div class="name" id="displayName"></div>
                    <div class="bio" id="displayBio"></div>
                </div>
            </div>
            <div class="settings-btn" onclick="openSettings()"><i class="fa-solid fa-sliders"></i></div>
        </div>

        <!-- 网格 -->
        <div class="grid-system" id="gridSystem"></div>
    </div>

    <!-- 1. 卡片编辑弹窗 -->
    <div class="modal-overlay" id="cardModal">
        <div class="modal-box" onclick="event.stopPropagation()">
            <h3 style="text-align:center;">卡片编辑</h3>
            
            <div class="form-group">
                <label class="form-label">功能类型</label>
                <select id="cardType" class="form-select" onchange="toggleCardInputs()">
                    <option value="link">链接跳转</option>
                    <option value="weixin">微信 (支持二维码)</option>
                    <option value="coffee">打赏/Buy Me a Coffee</option>
                    <option value="image">纯图片</option>
                    <option value="location">地理位置</option>
                    <option value="bilibili">B站</option>
                    <option value="youtube">YouTube</option>
                    <option value="instagram">Instagram</option>
                    <option value="tiktok">TikTok</option>
                    <option value="twitter">Twitter / X</option>
                    <option value="github">GitHub</option>
                    <option value="mail">邮箱</option>
                    <option value="discord">Discord</option>
                    <option value="telegram">Telegram</option>
                    <option value="whatsapp">WhatsApp</option>
                    <option value="line">LINE</option>
                    <option value="facebook">Facebook</option>
                    <option value="twitch">Twitch</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">卡片尺寸</label>
                <select id="cardSpan" class="form-select">
                    <option value="1x1">1x1 (正方形)</option>
                    <option value="h2">横跨 2格</option>
                    <option value="h3">横跨 3格</option>
                    <option value="h4">横跨 4格</option>
                    <option value="h5">横跨 5格</option>
                    <option value="v2">纵向 2格</option>
                </select>
            </div>

            <div class="form-group" id="inputTitleGroup">
                <label class="form-label">标题</label>
                <input type="text" id="cardTitle" class="form-input" placeholder="显示名称">
            </div>

            <div class="form-group" id="inputContentGroup">
                <label class="form-label">链接 / 内容</label>
                <input type="text" id="cardContent" class="form-input" placeholder="https://...">
            </div>

            <div class="form-group" id="inputImageGroup" style="display:none;">
                <label class="form-label">上传图片</label>
                <input type="file" id="cardImageFile" accept="image/*" class="form-input">
                <div class="progress-bar" id="imgProgress"><div class="progress-fill"></div></div>
                <input type="hidden" id="cardImageUrl">
            </div>

            <div class="form-group" id="inputQrGroup" style="display:none;">
                <label class="form-label">上传二维码</label>
                <input type="file" id="cardQrFile" accept="image/*" class="form-input">
                <div class="progress-bar" id="qrProgress"><div class="progress-fill"></div></div>
                <input type="hidden" id="cardQrUrl">
            </div>

            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn btn-danger" id="btnDelete" onclick="deleteCard()">删除</button>
                <button class="btn btn-primary" onclick="saveCard()">保存</button>
            </div>
            <button class="btn btn-text" onclick="closeModal('cardModal')">取消</button>
        </div>
    </div>

    <!-- 2. 全局设置弹窗 -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-box">
            <h3 style="text-align:center;">设置</h3>
            
            <div class="modal-section-title">个人资料</div>
            <div class="form-group">
                <input type="text" id="editName" class="form-input" placeholder="名字">
                <input type="text" id="editBio" class="form-input" placeholder="简介">
            </div>
            <div class="form-group">
                <label class="form-label" style="display:flex; justify-content:space-between;">头像 <span>点击选择文件</span></label>
                <input type="file" id="avatarFile" accept="image/*" class="form-input">
                <input type="hidden" id="editAvatar">
            </div>

            <div class="modal-section-title">外观风格</div>
            <div class="form-group">
                <select id="styleSelect" class="form-select">
                    <option value="transparent">透明毛玻璃</option>
                    <option value="dark">深色遮罩</option>
                    <option value="white">浅色遮罩</option>
                </select>
                <select id="borderSelect" class="form-select">
                    <option value="show">显示卡片边框</option>
                    <option value="hide">隐藏卡片边框</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">背景图片</label>
                <input type="file" id="bgFile" accept="image/*" class="form-input">
                <div class="progress-bar" id="bgProgress"><div class="progress-fill"></div></div>
                <input type="hidden" id="editBg">
                <div style="display:flex; gap:10px; margin-top:5px;">
                    <input type="color" id="bgColorPicker" style="height:35px; width:50px; padding:0; border:none; border-radius:5px;" value="#2c2c2e">
                    <button class="btn" style="padding:5px; font-size:0.8rem; background:rgba(255,255,255,0.1); width:auto; flex:1;" onclick="clearBg()">清除图片使用纯色</button>
                </div>
            </div>

            <div class="modal-section-title">布局</div>
            <div class="form-group">
                <label class="form-label">一行 <span id="colVal">3</span> 列</label>
                <input type="range" id="colRange" min="2" max="5" step="1" style="width:100%" oninput="updateColPreview(this.value)">
            </div>
            <div class="form-group">
                <label class="form-label">总格数: <span id="gridTotalVal">15</span></label>
                <input type="range" id="totalRange" min="9" max="60" step="3" style="width:100%" oninput="updateTotalPreview(this.value)">
            </div>

            <div id="authArea" style="margin-top:15px; border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;">
                <button class="btn" style="background:#0a84ff; color:#fff" onclick="enterAdminFlow()">验证 Token 进入管理模式</button>
            </div>

            <button class="btn btn-primary" id="saveSettingsBtn" style="display:none;" onclick="saveSettings()">保存修改</button>
            <button class="btn btn-text" onclick="closeModal('settingsModal')">关闭</button>
        </div>
    </div>

    <script>
        // ================= 配置区 =================
        const GIST_ID = 'b9e8463f5dc1966839dc2f675bfabffe'; 
        const REPO_OWNER = 'caisiyang';
        const REPO_NAME = 'saaaai';
        const GIST_FILENAME = 'data.json';

        // ================= 状态 =================
        let appData = {
            config: { gridColumns: 3, gridSize: 15, bgImage: "", bgColor: "#3a2e2e", cardStyle: "transparent", hideBorder: false },
            profile: { name: "加载中...", bio: "...", avatar: "" },
            grid: Array(15).fill(null)
        };
        
        let githubToken = localStorage.getItem('gh_token') || '';
        let isAdmin = false;
        let activeSlotIndex = -1;
        
        // 拖拽变量
        let isDragging = false;
        let dragStartIndex = -1;
        let dragGhost = null;
        let touchOffsetX = 0;
        let touchOffsetY = 0;

        const iconMap = {
            link: "fa-solid fa-link", 
            weixin: "fa-brands fa-weixin", 
            coffee: "fa-solid fa-mug-hot",
            location: "fa-solid fa-location-dot",
            bilibili: "fa-brands fa-bilibili", 
            github: "fa-brands fa-github", 
            mail: "fa-solid fa-envelope",
            image: "fa-regular fa-image",
            youtube: "fa-brands fa-youtube",
            instagram: "fa-brands fa-instagram",
            tiktok: "fa-brands fa-tiktok",
            twitter: "fa-brands fa-x-twitter",
            discord: "fa-brands fa-discord",
            telegram: "fa-brands fa-telegram",
            whatsapp: "fa-brands fa-whatsapp",
            line: "fa-brands fa-line",
            facebook: "fa-brands fa-facebook",
            twitch: "fa-brands fa-twitch"
        };

        // ================= 初始化 =================
        async function init() {
            await loadFromCloud();
            applyStyles();
            renderAll();
            setupEvents();
        }

        async function loadFromCloud() {
            try {
                const res = await fetch(`https://api.github.com/gists/${GIST_ID}`);
                if (!res.ok) throw new Error("Gist Error");
                const data = await res.json();
                const content = JSON.parse(data.files[GIST_FILENAME].content);
                appData = { ...appData, ...content };
                syncGridSize(appData.config.gridSize || 15);
                localStorage.setItem('myHomeBackup', JSON.stringify(appData));
            } catch (e) {
                const local = localStorage.getItem('myHomeBackup');
                if (local) {
                    appData = JSON.parse(local);
                    syncGridSize(appData.config.gridSize);
                }
            }
        }

        function syncGridSize(targetSize) {
            if (!appData.grid) appData.grid = [];
            if (appData.grid.length !== targetSize) {
                const newGrid = Array(targetSize).fill(null);
                appData.grid.forEach((item, i) => { if(i < targetSize) newGrid[i] = item; });
                appData.grid = newGrid;
            }
        }

        async function saveToCloud() {
            localStorage.setItem('myHomeBackup', JSON.stringify(appData)); // 立即存本地
            if (!isAdmin || !githubToken) return;
            try {
                await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `token ${githubToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ files: { [GIST_FILENAME]: { content: JSON.stringify(appData) } } })
                });
            } catch(e) { console.error("Cloud save error"); }
        }

        // ================= 渲染系统 =================
        function applyStyles() {
            if (appData.config.bgImage && appData.config.bgImage.trim() !== "") {
                document.body.style.backgroundImage = `url('${appData.config.bgImage}')`;
            } else {
                document.body.style.backgroundImage = 'none';
                document.body.style.backgroundColor = appData.config.bgColor || "#3a2e2e";
            }
            
            // 设置列数
            document.getElementById('gridSystem').style.gridTemplateColumns = `repeat(${appData.config.gridColumns || 3}, 1fr)`;
            
            document.body.classList.remove('style-white', 'style-dark', 'no-border');
            if (appData.config.cardStyle === 'white') document.body.classList.add('style-white');
            if (appData.config.cardStyle === 'dark') document.body.classList.add('style-dark');
            if (appData.config.hideBorder) document.body.classList.add('no-border');
        }

        function renderAll() {
            document.getElementById('displayName').textContent = appData.profile.name;
            document.getElementById('displayBio').textContent = appData.profile.bio;
            if(appData.profile.avatar) document.getElementById('displayAvatar').src = appData.profile.avatar;

            const container = document.getElementById('gridSystem');
            container.innerHTML = '';

            appData.grid.forEach((item, index) => {
                const slot = document.createElement('div');
                slot.className = 'grid-slot';
                slot.dataset.index = index;

                if (item) {
                    // 添加跨格类，横向跨格卡片会自动变成 flex-row 布局
                    if (item.span && item.span !== '1x1') {
                        slot.classList.add(`span-${item.span}`);
                    }
                    
                    const card = document.createElement('div');
                    // 标记是否为横向长卡片
                    const isHorizontal = item.span && item.span.startsWith('h');
                    card.className = `card type-${item.type} ${item.span ? `span-${item.span}` : ''} ${isHorizontal ? 'span-h' : ''}`;
                    
                    let html = '';
                    if ((item.type === 'weixin' || item.type === 'coffee') && item.qrCode) {
                        html += `<div class="qr-overlay"><img src="${item.qrCode}" class="qr-img"></div>`;
                    }

                    if (item.type === 'image') {
                        html += `<img src="${item.content}" class="card-bg-img">`;
                    } else if (item.type === 'location' && item.span !== '1x1') {
                        html += `<i class="fa-solid fa-map-location-dot" style="font-size:3rem; opacity:0.3;"></i>
                                <div style="position:absolute; bottom:10px; font-weight:bold">${item.title}</div>`;
                    } else {
                        html += `<i class="${iconMap[item.type] || 'fa-solid fa-link'} card-icon"></i>
                                <div class="card-text-box" style="text-align:center">
                                    <div class="card-title">${item.title}</div>
                                    <div class="card-content">${item.content}</div>
                                </div>`;
                    }
                    
                    html += `<div class="card-edit-btn" onclick="openEditModal(${index}, false, event)"><i class="fa-solid fa-pen"></i></div>`;
                    
                    card.innerHTML = html;
                    bindCardEvents(card, index, item);
                    slot.appendChild(card);
                } else {
                    slot.classList.add('empty');
                    if(isAdmin) slot.onclick = () => openEditModal(index, true);
                }
                container.appendChild(slot);
            });
        }

        // ================= 交互与事件 =================
        function bindCardEvents(card, index, item) {
            if (!isAdmin) {
                card.onclick = () => handleCardClick(card, item);
                return;
            }
            card.onmousedown = (e) => startDrag(e, index, card, false);
            card.ontouchstart = (e) => startDrag(e, index, card, true);
        }

        function handleCardClick(cardEl, item) {
            const isLink = ['link', 'bilibili', 'github', 'youtube', 'instagram', 'tiktok', 'twitter', 'discord', 'telegram', 'facebook', 'twitch'].includes(item.type);
            
            if (isLink) {
                if (item.content.startsWith('http')) window.open(item.content, '_blank');
                else alert("无效链接，请以 http 开头");
                return;
            }
            
            if (item.type === 'weixin' || item.type === 'coffee') {
                if (item.qrCode) {
                    const overlay = cardEl.querySelector('.qr-overlay');
                    if(overlay) overlay.style.display = (overlay.style.display === 'flex') ? 'none' : 'flex';
                } else {
                    if(item.type === 'weixin') {
                        navigator.clipboard.writeText(item.content);
                        alert("已复制: " + item.content);
                    } else {
                        if(item.content.startsWith('http')) window.open(item.content, '_blank');
                    }
                }
                return;
            }

            if (item.type === 'mail') { window.location.href = `mailto:${item.content}`; return; }
            if (item.type === 'whatsapp') { window.open(`https://wa.me/${item.content}`, '_blank'); return; }
            if (item.type === 'line') { window.open(`https://line.me/ti/p/~${item.content}`, '_blank'); return; }

            if (item.content) {
                navigator.clipboard.writeText(item.content);
                alert("已复制");
            }
        }

        // ================= 拖拽逻辑 =================
        function startDrag(e, index, cardEl, isTouch) {
            if (e.target.closest('.card-edit-btn')) return;
            isDragging = true; dragStartIndex = index;
            
            const clientX = isTouch ? e.touches[0].clientX : e.clientX;
            const clientY = isTouch ? e.touches[0].clientY : e.clientY;
            const rect = cardEl.getBoundingClientRect();
            touchOffsetX = clientX - rect.left;
            touchOffsetY = clientY - rect.top;

            dragGhost = cardEl.cloneNode(true);
            dragGhost.classList.add('dragging-active');
            dragGhost.style.width = rect.width + 'px';
            dragGhost.style.height = rect.height + 'px';
            document.body.appendChild(dragGhost);
            cardEl.classList.add('dragging-placeholder');

            if (isTouch) {
                document.ontouchmove = (ev) => onMove(ev, true);
                document.ontouchend = (ev) => onEnd(ev, true);
            } else {
                document.onmousemove = (ev) => onMove(ev, false);
                document.onmouseup = (ev) => onEnd(ev, false);
            }
            updateGhostPos(clientX, clientY);
        }

        function onMove(e, isTouch) {
            if (!isDragging) return;
            if(e.cancelable) e.preventDefault(); 
            const clientX = isTouch ? e.touches[0].clientX : e.clientX;
            const clientY = isTouch ? e.touches[0].clientY : e.clientY;
            updateGhostPos(clientX, clientY);
        }

        function updateGhostPos(x, y) {
            if(dragGhost) {
                dragGhost.style.left = (x - touchOffsetX) + 'px';
                dragGhost.style.top = (y - touchOffsetY) + 'px';
            }
        }

        function onEnd(e, isTouch) {
            if (!isDragging) return;
            isDragging = false;
            let clientX = isTouch ? e.changedTouches[0].clientX : e.clientX;
            let clientY = isTouch ? e.changedTouches[0].clientY : e.clientY;

            if (dragGhost) dragGhost.remove();
            dragGhost = null;
            document.ontouchmove = null; document.ontouchend = null;
            document.onmousemove = null; document.onmouseup = null;

            let targetEl = document.elementFromPoint(clientX, clientY);
            let slot = targetEl ? targetEl.closest('.grid-slot') : null;

            if (slot) {
                const targetIndex = parseInt(slot.dataset.index);
                if (targetIndex !== dragStartIndex && !isNaN(targetIndex)) {
                    const temp = appData.grid[dragStartIndex];
                    appData.grid[dragStartIndex] = appData.grid[targetIndex];
                    appData.grid[targetIndex] = temp;
                    renderAll();
                    saveToCloud(); 
                    return;
                }
            }
            renderAll(); 
        }

        // ================= 设置与管理 =================
        function openSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.add('active');
            
            document.getElementById('editName').value = appData.profile.name;
            document.getElementById('editBio').value = appData.profile.bio;
            document.getElementById('colRange').value = appData.config.gridColumns || 3;
            document.getElementById('colVal').innerText = appData.config.gridColumns || 3;
            document.getElementById('totalRange').value = appData.config.gridSize || 15;
            document.getElementById('gridTotalVal').innerText = appData.config.gridSize || 15;
            document.getElementById('styleSelect').value = appData.config.cardStyle || 'transparent';
            document.getElementById('borderSelect').value = appData.config.hideBorder ? 'hide' : 'show';
            document.getElementById('editBg').value = appData.config.bgImage || "";
            document.getElementById('bgColorPicker').value = appData.config.bgColor || "#3a2e2e";

            updateAuthUI();
        }

        function clearBg() {
            document.getElementById('bgFile').value = "";
            document.getElementById('editBg').value = "";
            alert("背景图片已清除");
        }

        async function saveSettings() {
            if(!isAdmin) return;

            const avaUrl = await uploadFileToGitHub('avatarFile');
            if(avaUrl) appData.profile.avatar = avaUrl;

            const bgFileUrl = await uploadFileToGitHub('bgFile', 'bgProgress');
            if (bgFileUrl) appData.config.bgImage = bgFileUrl;
            else appData.config.bgImage = document.getElementById('editBg').value;

            appData.config.bgColor = document.getElementById('bgColorPicker').value;
            appData.profile.name = document.getElementById('editName').value;
            appData.profile.bio = document.getElementById('editBio').value;
            appData.config.gridColumns = parseInt(document.getElementById('colRange').value);
            appData.config.cardStyle = document.getElementById('styleSelect').value;
            appData.config.hideBorder = document.getElementById('borderSelect').value === 'hide';

            const newSize = parseInt(document.getElementById('totalRange').value);
            syncGridSize(newSize);
            appData.config.gridSize = newSize;

            saveToCloud();
            applyStyles();
            renderAll();
            closeModal('settingsModal');
        }

        function enterAdminFlow() {
            const token = prompt("GitHub Token:", githubToken);
            if(token) {
                githubToken = token;
                localStorage.setItem('gh_token', token);
                isAdmin = true;
                document.body.classList.add('admin-mode');
                document.getElementById('adminControls').style.display = 'flex';
                updateAuthUI();
                renderAll();
            }
        }

        function exitAdminFlow() {
            isAdmin = false;
            document.body.classList.remove('admin-mode');
            document.getElementById('adminControls').style.display = 'none';
            renderAll();
        }

        function updateAuthUI() {
            const btn = document.getElementById('saveSettingsBtn');
            const authArea = document.getElementById('authArea');
            if (isAdmin) { btn.style.display = 'block'; authArea.style.display = 'none'; } 
            else { btn.style.display = 'none'; authArea.style.display = 'block'; }
        }

        function openEditModal(index, isNew, e) {
            if(e) e.stopPropagation();
            activeSlotIndex = index;
            const item = appData.grid[index];
            
            document.getElementById('cardImageFile').value = '';
            document.getElementById('cardQrFile').value = ''; 
            document.getElementById('imgProgress').style.display = 'none';
            document.getElementById('qrProgress').style.display = 'none';
            document.getElementById('btnDelete').style.display = isNew ? 'none' : 'block';

            if (isNew) {
                document.getElementById('cardType').value = 'link';
                document.getElementById('cardTitle').value = '';
                document.getElementById('cardContent').value = '';
                document.getElementById('cardSpan').value = '1x1';
            } else {
                document.getElementById('cardType').value = item.type;
                document.getElementById('cardTitle').value = item.title;
                document.getElementById('cardContent').value = item.content;
                document.getElementById('cardSpan').value = item.span || '1x1';
                if(item.type==='image') document.getElementById('cardImageUrl').value = item.content;
                if(item.type==='weixin' || item.type==='coffee') document.getElementById('cardQrUrl').value = item.qrCode || "";
            }
            toggleCardInputs();
            document.getElementById('cardModal').classList.add('active');
        }

        function toggleCardInputs() {
            const type = document.getElementById('cardType').value;
            document.getElementById('inputImageGroup').style.display = (type === 'image') ? 'block' : 'none';
            document.getElementById('inputQrGroup').style.display = (type === 'weixin' || type === 'coffee') ? 'block' : 'none';
            document.getElementById('inputContentGroup').style.display = (type === 'image') ? 'none' : 'block';
            
            let ph = "https://...";
            if(type==='weixin') ph = "微信号";
            if(type==='mail') ph = "example@mail.com";
            if(type==='coffee') ph = "链接 (可选)";
            document.getElementById('cardContent').placeholder = ph;
        }

        async function saveCard() {
            const type = document.getElementById('cardType').value;
            let content = document.getElementById('cardContent').value;
            let qrCode = "";

            if (type === 'image') {
                const url = await uploadFileToGitHub('cardImageFile', 'imgProgress');
                if(url) content = url;
                else content = document.getElementById('cardImageUrl').value;
            }
            
            if (type === 'weixin' || type === 'coffee') {
                const url = await uploadFileToGitHub('cardQrFile', 'qrProgress');
                if(url) qrCode = url;
                else qrCode = document.getElementById('cardQrUrl').value;
            }

            appData.grid[activeSlotIndex] = {
                type: type,
                title: document.getElementById('cardTitle').value,
                content: content,
                qrCode: qrCode,
                span: document.getElementById('cardSpan').value
            };
            saveToCloud();
            renderAll();
            closeModal('cardModal');
        }

        function deleteCard() {
            if(confirm("删除?")) { appData.grid[activeSlotIndex] = null; saveToCloud(); renderAll(); closeModal('cardModal'); }
        }

        async function uploadFileToGitHub(inputId, progressId) {
            const input = document.getElementById(inputId);
            if(!input.files || !input.files[0]) return null;
            const file = input.files[0];
            const reader = new FileReader();
            return new Promise((resolve, reject) => {
                reader.onload = async (e) => {
                    const b64 = e.target.result.split(',')[1];
                    const path = `uploads/${Date.now()}_${file.name}`;
                    const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`;
                    if(progressId) document.getElementById(progressId).style.display = 'block';
                    try {
                        const res = await fetch(url, {
                            method: 'PUT',
                            headers: { 'Authorization': `token ${githubToken}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: 'upload', content: b64 })
                        });
                        const data = await res.json();
                        resolve(data.content.download_url);
                    } catch(err) { alert("上传失败"); resolve(null); }
                };
                reader.readAsDataURL(file);
            });
        }

        function updateColPreview(val) { document.getElementById('colVal').innerText = val; }
        function updateTotalPreview(val) { document.getElementById('gridTotalVal').innerText = val; }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function setupEvents() {
            document.querySelectorAll('.modal-overlay').forEach(el => {
                el.addEventListener('click', (e) => { if(e.target===el) el.classList.remove('active'); });
            });
        }

        init();
    </script>
</body>
</html>